<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Join Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            margin-bottom: 20px;
        }
        #log {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', Courier, monospace;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-info {
            color: #0c5460;
        }
        .log-success {
            color: #155724;
        }
        .log-error {
            color: #721c24;
        }
        .log-warning {
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Room Join Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Create Room</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="firebaseUid1" class="form-label">Firebase UID</label>
                            <input type="text" id="firebaseUid1" class="form-control" value="test123">
                        </div>
                        <button id="createRoomBtn" class="btn btn-primary">Create Room</button>
                        <div id="roomInfo" class="alert alert-success mt-3" style="display: none;">
                            <p>Room Code: <span id="roomCode"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Join Room</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="firebaseUid2" class="form-label">Firebase UID</label>
                            <input type="text" id="firebaseUid2" class="form-control" value="test456">
                        </div>
                        <div class="mb-3">
                            <label for="roomCodeInput" class="form-label">Room Code</label>
                            <input type="text" id="roomCodeInput" class="form-control">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="joinMethod" id="joinMethodApi" value="api" checked>
                                <label class="form-check-label" for="joinMethodApi">
                                    Join via API
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="joinMethod" id="joinMethodWs" value="websocket">
                                <label class="form-check-label" for="joinMethodWs">
                                    Join via WebSocket
                                </label>
                            </div>
                        </div>
                        <button id="joinRoomBtn" class="btn btn-success">Join Room</button>
                        <div id="joinInfo" class="alert alert-info mt-3" style="display: none;">
                            <p>Joined Room: <span id="joinedRoomCode"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Log</div>
            <div class="card-body">
                <div id="log"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            API_URL: '/api',
            WS_ENDPOINT: '/ws',
            SOCKET: {
                PERSONAL_QUEUE: '/queue/game',
                ROOM_TOPIC_PREFIX: '/topic/game.room.',
                ENDPOINTS: {
                    JOIN: '/app/game.join',
                    LEAVE: '/app/game.leave'
                }
            }
        };
        
        // State
        let stompClient = null;
        let currentRoomCode = '';
        
        // DOM Elements
        const elements = {
            createRoom: {
                firebaseUid: document.getElementById('firebaseUid1'),
                createBtn: document.getElementById('createRoomBtn'),
                roomInfo: document.getElementById('roomInfo'),
                roomCode: document.getElementById('roomCode')
            },
            joinRoom: {
                firebaseUid: document.getElementById('firebaseUid2'),
                roomCodeInput: document.getElementById('roomCodeInput'),
                joinMethodApi: document.getElementById('joinMethodApi'),
                joinMethodWs: document.getElementById('joinMethodWs'),
                joinBtn: document.getElementById('joinRoomBtn'),
                joinInfo: document.getElementById('joinInfo'),
                joinedRoomCode: document.getElementById('joinedRoomCode')
            },
            log: document.getElementById('log')
        };
        
        // Initialize
        function init() {
            // Set up event listeners
            elements.createRoom.createBtn.addEventListener('click', createRoom);
            elements.joinRoom.joinBtn.addEventListener('click', joinRoom);
            
            // Connect to WebSocket
            connectWebSocket();
            
            logMessage('Test page initialized', 'info');
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            try {
                // Create SockJS and STOMP client
                const socket = new SockJS(CONFIG.WS_ENDPOINT);
                stompClient = Stomp.over(socket);
                
                // Disable debug logs
                stompClient.debug = null;
                
                // Connect to WebSocket
                stompClient.connect(
                    {},
                    function() {
                        logMessage('Connected to WebSocket', 'success');
                        
                        // Subscribe to personal queue
                        stompClient.subscribe(CONFIG.SOCKET.PERSONAL_QUEUE, onMessageReceived);
                    },
                    function(error) {
                        logMessage(`WebSocket connection error: ${error}`, 'error');
                    }
                );
            } catch (e) {
                logMessage(`WebSocket connection exception: ${e.message}`, 'error');
            }
        }
        
        // Create a room
        function createRoom() {
            const firebaseUid = elements.createRoom.firebaseUid.value.trim();
            
            if (!firebaseUid) {
                logMessage('Please enter a Firebase UID', 'error');
                return;
            }
            
            logMessage(`Creating room with Firebase UID: ${firebaseUid}`, 'info');
            
            fetch(`${CONFIG.API_URL}/game/room?firebaseUid=${firebaseUid}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Firebase-Uid': firebaseUid
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to create room. Status: ${response.status}`);
                }
                return response.json();
            })
            .then(room => {
                logMessage(`Room created with code: ${room.roomCode}`, 'success');
                
                // Update UI
                elements.createRoom.roomCode.textContent = room.roomCode;
                elements.createRoom.roomInfo.style.display = 'block';
                
                // Auto-fill the join room code input
                elements.joinRoom.roomCodeInput.value = room.roomCode;
                
                // Store room code
                currentRoomCode = room.roomCode;
                
                // Subscribe to room topic
                subscribeToRoom(room.roomCode);
            })
            .catch(error => {
                logMessage(`Error creating room: ${error.message}`, 'error');
            });
        }
        
        // Join a room
        function joinRoom() {
            const firebaseUid = elements.joinRoom.firebaseUid.value.trim();
            const roomCode = elements.joinRoom.roomCodeInput.value.trim().toUpperCase();
            const useApi = elements.joinRoom.joinMethodApi.checked;
            
            if (!firebaseUid) {
                logMessage('Please enter a Firebase UID', 'error');
                return;
            }
            
            if (!roomCode) {
                logMessage('Please enter a room code', 'error');
                return;
            }
            
            logMessage(`Joining room ${roomCode} with Firebase UID: ${firebaseUid} via ${useApi ? 'API' : 'WebSocket'}`, 'info');
            
            if (useApi) {
                // Join via API
                joinRoomViaApi(roomCode, firebaseUid);
            } else {
                // Join via WebSocket
                joinRoomViaWebSocket(roomCode, firebaseUid);
            }
        }
        
        // Join room via API
        function joinRoomViaApi(roomCode, firebaseUid) {
            fetch(`${CONFIG.API_URL}/game/room/${roomCode}/join?firebaseUid=${firebaseUid}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Firebase-Uid': firebaseUid
                },
                body: JSON.stringify({
                    firebaseUid: firebaseUid
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to join room. Status: ${response.status}`);
                }
                return response.json();
            })
            .then(room => {
                logMessage(`Joined room ${room.roomCode} via API`, 'success');
                
                // Update UI
                elements.joinRoom.joinedRoomCode.textContent = room.roomCode;
                elements.joinRoom.joinInfo.style.display = 'block';
                
                // Store room code
                currentRoomCode = room.roomCode;
                
                // Subscribe to room topic
                subscribeToRoom(room.roomCode);
            })
            .catch(error => {
                logMessage(`Error joining room via API: ${error.message}`, 'error');
            });
        }
        
        // Join room via WebSocket
        function joinRoomViaWebSocket(roomCode, firebaseUid) {
            if (!stompClient || !stompClient.connected) {
                logMessage('WebSocket not connected', 'error');
                return;
            }
            
            // Subscribe to room topic
            subscribeToRoom(roomCode);
            
            // Send join message
            stompClient.send(CONFIG.SOCKET.ENDPOINTS.JOIN, {
                firebaseUid: firebaseUid
            }, JSON.stringify({
                type: 'JOIN_ROOM',
                roomCode: roomCode,
                senderId: firebaseUid,
                senderUsername: `User_${firebaseUid.substring(0, 5)}`
            }));
            
            logMessage(`Join request sent via WebSocket for room ${roomCode}`, 'info');
            
            // Update UI
            elements.joinRoom.joinedRoomCode.textContent = roomCode;
            elements.joinRoom.joinInfo.style.display = 'block';
            
            // Store room code
            currentRoomCode = roomCode;
        }
        
        // Subscribe to a room topic
        function subscribeToRoom(roomCode) {
            if (!stompClient || !stompClient.connected) {
                logMessage('WebSocket not connected', 'error');
                return false;
            }
            
            try {
                logMessage(`Subscribing to room topic: ${roomCode}`, 'info');
                stompClient.subscribe(
                    CONFIG.SOCKET.ROOM_TOPIC_PREFIX + roomCode,
                    onMessageReceived
                );
                return true;
            } catch (e) {
                logMessage(`Error subscribing to room: ${e.message}`, 'error');
                return false;
            }
        }
        
        // Handle incoming WebSocket messages
        function onMessageReceived(payload) {
            try {
                const message = JSON.parse(payload.body);
                logMessage(`Received message: ${message.type}`, 'info');
                
                // Handle different message types
                switch (message.type) {
                    case 'ROOM_JOINED':
                        logMessage(`${message.senderUsername} joined room ${message.roomCode}`, 'success');
                        break;
                    case 'ERROR':
                        logMessage(`Error: ${message.content}`, 'error');
                        break;
                    default:
                        logMessage(`Received message of type ${message.type}: ${JSON.stringify(message)}`, 'info');
                }
            } catch (error) {
                logMessage(`Error processing message: ${error.message}`, 'error');
            }
        }
        
        // Log message
        function logMessage(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            elements.log.appendChild(logEntry);
            elements.log.scrollTop = elements.log.scrollHeight;
        }
        
        // Initialize the test page
        init();
    </script>
</body>
</html> 